---
title: "Diamond Princess"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Assume true underlying fatitilty rate is equal $\mu$. (Botential for hierarcical model).
Only look at data age >=60.

missreporting rate = $p \in (0,1)$

probability observind d death on ship is poison 

$P(d) = \frac{e ^\mu \mu ^d}{d!}$

$\mu_{n0} = D_n/N_n$ ovserved fatility rate netherland D death N number confirmed

with misrepoting rate 

$\mu_{np} = D_n/(N_n(1-p))$ true fatility rate

Expected number of death on cruise ship $d_p = \mu_{np}*n_n$


Assign gamma $\alpha, \beta$ as prior .....
se https://www.who.int/bulletin/online_first/20-254565.pdf


posterior:
𝑃(𝜇|𝑁,𝐷, 𝑝)~𝐺𝑎𝑚𝑚𝑎(𝑑௣ + �

some strange way of defining a and b.� + 1,2𝑛)

```{r}
N_n = 20024
D_n = 4565

n  = 449
d = 13
```

```{r}
N_n = 1408 + 3918 + 8583
D_n = 208 + 312+ 309

d = 4
n = 54 + 234+ 177

```

```{r}

mu_p <- function (p){
  return (((1-p)*D_n)/N_n)
}

d_p <- function(p){
  return (mu_p(p)*n)
}

```
```{r}
p <- seq(0.001, 0.999, by= 0.001)
n_sample = 10000
#p(d<13|N, d, p)

prob <- rep(0, length(p))
prob2 <- rep(0, length(p))
prob3 <- rep(0, length(p))
quantile025 <- rep(0, length(p))
quantile975 <- rep(0, length(p))
for (i in 1:length(prob)){
  alpha = (d_p(p[i]) + d + 1)
  beta = 2*n
  mu <- rgamma(n, shape = alpha, scale = 1/beta)
  #mu = (d_p(p[i]) + d)/(2*n)
  draw <- rpois(n, mu*n)
  count <- which(draw<=d)
  prob[i]<- length(count)/length(draw)
  map_mu <- (d_p(p[i]) + d)/(2*n)
  mean_mu <- mean(mu)
  q_025 <- qgamma(0.025, shape = alpha, scale = 1/beta)
  q_975 <- qgamma(0.975, shape = alpha, scale = 1/beta)

  x = seq(1, d, 1)
  prob2[i] <- sum(dpois(x, map_mu*n))
  quantile025[i] <- sum(dpois(x, q_025*n))
  quantile975[i] <- sum(dpois(x, q_975*n))
  prob3[i] <- sum(dpois(x, mean_mu*n))
}

ggplot(data = tibble(p, prob, prob2, prob3, quantile025, quantile975), aes(p, prob)) + geom_point() + geom_line(aes(p, prob2), col = "blue") + geom_line(aes(p, quantile025), col = "red") + geom_line(aes(p, quantile975), col = "red")+ geom_line(aes(p, prob3), col = "green")+geom_hline(yintercept = 0.05)
#ggplot(data = tibble(p, prob2), aes(p, prob2)) + geom_line() + geom_hline(yintercept = 0.05)
```

```{r}
mu <- D_n/N_n
mu
```

```{r}
#index 724 = 0.05
#misreporting rate 72.4 % 

#true mortality rate: 

mu_p(0.724)

#true number of cases

all_death <- 4710
all_confirmed <- 38802

cases <- all_confirmed/(1-0.724) #not able to reproduce the result for china, I get 85000 report says 15000
cases
N_n

true_deathrate <- all_death/cases
true_deathrate
```
6 % among elderly deathrate
3 % among total population

estimate total of 140587 cases

#now assume equally many infected in each agesegment above 15 years
```{r}
peaple_60_plus = 4436518
people_60_min = 10131501

true_case_60 = N_n/(1-0.724)
true_cases_tot = true_case_60 + true_case_60*people_60_min/peaple_60_plus
true_cases_tot
```

