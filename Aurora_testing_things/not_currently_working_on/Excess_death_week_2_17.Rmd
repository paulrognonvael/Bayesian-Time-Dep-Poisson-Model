---
title: "Excess_death_netherland_week_2-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
average_death_per_year = (139223 + 147134+ 148997 + 150214 + 153363 + 151793)/6
average_per_week = average_death_per_year/52
average_per_week
```

```{r}
alpha <- 8.1503
beta <- 0.0028544
  
mean <- alpha/beta

var <- alpha/beta^2

theta <- seq(0.0001, 20000)
gamma_vec <- dgamma(theta, shape= alpha, scale = 1/beta)
```
```{r}
ggplot(data = tibble(lambda = theta, y = gamma_vec), aes(lambda,y)) + geom_line() + geom_vline(xintercept = average_per_week)
```

```{r}
data<- read.csv("Death_week_2_17_netherland.csv", sep = ";")
```

```{r}
(period_1<-as.vector(as.matrix(data)[1:4,2:4]))
(period_2<-as.vector(as.matrix(data)[5:8,2:4]))
(period_3<-as.vector(as.matrix(data)[9:12,2:4]))
(period_4<-as.vector(as.matrix(data)[13:16,2:4]))
```

```{r}
N <- length(period_1)
data_list <- list(
  N = N, 
  y1 = period_1,
  y2 = period_2,
  y3 = period_3,
  y4 = period_4,
  a = alpha,
  b = beta
  )

```

```{r}
death_netherland <- stan("exp_death_week_2_17.stan", iter = 1000, chains = 4,
  data = data_list, seed = 1)

```
```{r}
print(death_netherland)
```

```{r}
posterior <- as.data.frame(death_netherland)
CI1 <- quantile(posterior$lambda1, c(0.05, 0.95))
CI2 <- quantile(posterior$lambda2, c(0.05, 0.95))
CI3 <- quantile(posterior$lambda3, c(0.05, 0.95))
CI4 <- quantile(posterior$lambda4, c(0.05, 0.95))

mean1 <- mean(posterior$lambda1)
mean2 <- mean(posterior$lambda2)
mean3 <- mean(posterior$lambda3)
mean4 <- mean(posterior$lambda4)
```



# start again with predictions. 
```{r}
params <- paste0("lambda", 1:4 ,"")
plot_title <- ggtitle("Posterior distributions of lambda, heterogeneous model", "with medians and 80% intervals")
p_heter <- mcmc_areas(posterior, 
  pars = c(params), 
  prob = 0.8) + plot_title
p_heter
```


```{r}
n_sim <- 10000
post_predict1 <- rpois(n_sim, posterior[, "lambda1"])
post_predict2 <- rpois(n_sim, posterior[, "lambda2"])
post_predict3 <- rpois(n_sim, posterior[, "lambda3"])
post_predict4 <- rpois(n_sim, posterior[, "lambda4"])
## credibility interval
CI1<- quantile(post_predict1, c(0.05, 0.95))
CI2<- quantile(post_predict2, c(0.05, 0.95))
CI3<- quantile(post_predict3, c(0.05, 0.95))
CI4<- quantile(post_predict4, c(0.05, 0.95))

mean1<-mean(post_predict1)
mean2<-mean(post_predict2)
mean3<-mean(post_predict3)
mean4<-mean(post_predict4)
```


```{r}
N<-4
point_est <- c(rep(mean1, N), rep(mean2,N), rep(mean3,N), rep(mean4,N))
CI_lower <- c(rep(CI1[1], N), rep(CI2[1], N), rep(CI3[1], N), rep(CI4[1], N))
CI_upper <- c(rep(CI1[2], N), rep(CI2[2], N), rep(CI3[2], N), rep(CI4[2], N))
```

```{r}
data_2020<-as.vector(as.matrix(data)[,5])

posterior_data <- tibble(point_est, CI_lower, CI_upper, week = seq(2,17), data2020 = data["X2020"] )
```

```{r}
ggplot(data = posterior_data, aes(week, data_2020)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, point_est), col = "red") + 
  geom_line(aes(week, CI_lower), col = "blue") +
  geom_line(aes(week, CI_upper), col = "blue")
```

