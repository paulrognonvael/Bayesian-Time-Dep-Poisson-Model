---
title: "Spatial_test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rstan)
library(ggplot2)
library(tidyr)
```

Reading the data
```{r}
data<- read.csv("data/Death_week_2_17_netherland.csv", sep = ";")
data_2 <- read.csv("data/England_Wales_weekly.csv",sep = ";")
data_3 <- read.csv("data/italy_week_deaths.csv", sep = ",")

```

Extracting the data for the Netherland
```{r}
mean <- as.vector(as.matrix(data)[,6])
data_2020<-as.vector(as.matrix(data)[,5])
```

Extracting data England and Wales
```{r}
mean_england <- as.vector(as.matrix(data_2)[,12])
england_2020 <- as.vector(as.matrix(data_2)[,13])
```

Extracting data Italy
```{r}
mean_italy <- as.vector(as.matrix(data_3)[,9])
italy_2020 <- as.vector(as.matrix(data_3)[,8])
```
Setting up the stan list
```{r}
N_netherland <- length(mean)
data_list_netherland <- list(
  N = N_netherland, 
  E = mean,
  O = data_2020,
  mu1 = 0,
  mu2 = 0,
  sigma1 = 100,
  sigma2 = 10
  )
```


```{r}
N_england <- length(mean_england)
data_list_england <- list(
  N = N_england, 
  E = mean_england,
  O = england_2020,
  mu1 = 0,
  mu2 = 0,
  sigma1 = 100,
  sigma2 = 10
  )
```

```{r}
N_italy <- length(mean_italy)
data_list_italy <- list(
  N = N_italy, 
  E = mean_italy,
  O = italy_2020,
  mu1 = 0,
  mu2 = 0,
  sigma1 = 100,
  sigma2 = 10
  )
```
Fit the stan models
```{r}
death_netherland <- stan("test_spatial.stan", iter = 2000, chains = 4,
  data = data_list_netherland, seed = 1)

```

```{r}
death_england <- stan("test_spatial.stan", iter = 2000, chains = 4,
  data = data_list_england, seed = 1)

```

```{r}
death_italy <- stan("test_spatial.stan", iter = 2000, chains = 4,
  data = data_list_italy, seed = 1)

```
# Netherland
```{r}
print(death_netherland)

fit_netherland<-summary(death_netherland)
results_netherland <- as.data.frame(fit_netherland$summary)

```

Backtransform the results form log to normal
```{r}
CI_upper <- exp(results_netherland$`97.5%`)[1:16]
CI_lower <- exp(results_netherland$`2.5%`)[1:16]
theta <- exp(results_netherland$mean)[1:16]

```

Plot results
```{r}
week = seq(1:16)

ggplot(data = data.frame(week, CI_upper, CI_lower, theta), aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  ggtitle("Riskfactor for the Netherlands")

```
Is it a problem than 1 is outside the CI for week 1-8, this is before corona hit NL?

#England and Wales
```{r}
print(death_england)

fit_england<-summary(death_england)
results_england <- as.data.frame(fit_england$summary)

```

```{r}
CI_upper <- exp(results_england$`97.5%`)[1:16]
CI_lower <- exp(results_england$`2.5%`)[1:16]
theta <- exp(results_england$mean)[1:16]

```

```{r}
week = seq(1:16)

ggplot(data = tibble(week, CI_upper, CI_lower, theta), aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  ggtitle("Riskfactor in England and Wales")

```

# italy 
```{r}
print(death_italy)

fit_italy<-summary(death_italy)
results_italy <- as.data.frame(fit_italy$summary)

```

```{r}
CI_upper <- exp(results_italy$`97.5%`)[1:14]
CI_lower <- exp(results_italy$`2.5%`)[1:14]
theta <- exp(results_italy$mean)[1:14]

```

```{r}
week = seq(1:14)

ggplot(data = data.frame(week, CI_upper, CI_lower, theta), aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  ggtitle("Riskfactor in Italy")

```

##################


#test negbin
```{r}
N_netherland <- length(mean)
data_list_netherland <- list(
  N = N_netherland, 
  E = mean,
  O = data_2020, 
  a = 1,#15,
  b= 6000#1/200
  )
```

```{r}
death_netherland <- stan("Neg_bin_simple.stan", iter = 2000, chains = 4,
  data = data_list_netherland, seed = 1)

```

```{r}
print(death_netherland)

fit_netherland<-summary(death_netherland)
results_netherland <- as.data.frame(fit_netherland$summary)

```

Backtransform the results form log to normal
```{r}
CI_upper <- exp(results_netherland$`97.5%`)[1:16]
CI_lower <- exp(results_netherland$`2.5%`)[1:16]
theta <- exp(results_netherland$mean)[1:16]

```

Plot results
```{r}
week = seq(1:16)

ggplot(data = data.frame(week, CI_upper, CI_lower, theta), aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  ggtitle("Riskfactor for the Netherlands")

```

```{r}
N_england <- length(mean_england)
data_list_england <- list(
  N = N_england, 
  E = mean_england,
  O = england_2020,
  a = 1,#15,
  b= 6000#1/200
  )
```

```{r}
death_england <- stan("Neg_bin_time_deo.stan", iter = 2000, chains = 4,
  data = data_list_england, seed = 1)

```

```{r}
print(death_england)

fit_england<-summary(death_england)
results_england <- as.data.frame(fit_england$summary)

```

```{r}
CI_upper <- exp(results_england$`97.5%`[1:16] +results_england$`97.5%`[18:33])
CI_lower <- exp(results_england$`2.5%`[1:16] +results_england$`2.5%`[18:33])

theta <- exp(results_england$mean[1:16] +results_england$mean[18:33])

```

Plot results
```{r}
week = seq(1:16)

ggplot(data = data.frame(week, CI_upper, CI_lower, theta), aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  geom_hline(yintercept = 1, col = "red")
  ggtitle("Riskfactor for the Netherlands")

```

```{r}
N_italy <- length(mean_italy)
data_list_italy <- list(
  N = N_italy, 
  E = mean_italy,
  O = italy_2020,
  a = 1,#15,
  b= 6000#1/200
  )
```

```{r}
death_italy <- stan("Neg_bin_time_dep.stan", iter = 2000, chains = 4,
  data = data_list_italy, seed = 1)

```

```{r}
print(death_italy)

fit_italy<-summary(death_italy)
results_italy <- as.data.frame(fit_italy$summary)

```

```{r}
CI_upper <- exp(results_italy$`97.5%`[1:13] +results_italy$`97.5%`[15:27])
CI_lower <- exp(results_italy$`2.5%`[1:13] +results_italy$`2.5%`[15:27])

theta <- exp(results_italy$mean[1:13] +results_italy$mean[15:27])

#CI_upper <- exp(results_italy$`97.5%`)[1:14]
#CI_lower <- exp(results_italy$`2.5%`)[1:14]
#theta <- exp(results_italy$mean)[1:14]

```

Plot results
```{r}
week = seq(1:13)

ggplot(data = data.frame(week, CI_upper, CI_lower, theta), aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  geom_hline(yintercept = 1, col = "red")
  ggtitle("Riskfactor for italy")

```