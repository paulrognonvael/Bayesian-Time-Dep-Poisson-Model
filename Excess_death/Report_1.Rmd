---
title: "Excess death in relation to Covid-19"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    number_sections: yes
    toc: yes
params:
  stanfile: "neg_bin_time_dep.stan"
  iter: 5000
  adapt_delta: 0.99
  max_treedepth: 15
  
---

```{r, include=FALSE}
library(rstan)
library(ggplot2)
library(tidyr)
```


# Aim

This project aims to estimate a risk factor connected to excess death and analyse the correlation between this excess and reported cases of Covid-19. 

#######################################################################################################################################
# Data

The data used is weekly data of the total number of deaths in the following countries:

- Norway
- Netherland
- Belgium
- Germany
- Switserland
- Italy
- Spain
- France

The data is obtained for week 2- 17 for 2020-2018 
<!-- (# is this correct?)  -->
for all the countries and some additional years for some of the countries. 
The data is retrieved from national statistic centers for the recpectiv countries, see the bibliografy. 

To be able to preform analytics all data were transformed to the same structure visualized bellow. 
<!-- (# the are not 100% equal but though they still have the same structure).  -->

Later on the weekly number of corrona registered deaths will also be used. 

```{r}
head(read.csv("data/Death_week_2_17_netherland.csv", sep = ";"))
```

# Process 

<!-- (thought that we could discribe shourtly the different models we have been working on) -->


#######################################################################################################################################
# Model 

<!-- ####### This is wrong, needs to be changed to neg bin with  -->

The distribution used will be  

<!-- this has to change -->

$$(1)\hspace{0.3cm}O_i \sim Poisson(E_i\theta_i).$$

where $O_i$ are the observed number of deaths in week $i$, $E_i$ would be the known expected number of deaths for the same week and $\theta_i$ is the riskfactor connected to week $i$. $E_i$ will be the historical average of death for week $i$. This parameter is considered to be stable for the last ten years so it is estimated as an average of the number of years we have data for for the respective countries. 

Hence the model will estimate the risk factor $\theta_{i,2020}$. If 1 is outside of the credibal intervals the risk will be considerd significant and we can assume there is a precanse of exsess death. 

The $log(\theta_i)$ are assumed to follow a normal distribution with parameters 

$log(\theta_i)\sim Normal(\mu_i,\sigma_i)$ (#this might also change slightly)

with $\mu_i$ and $\sigma_i$ again are normaly distributed with shared hyperparameters. 

#######################################################################################################################################
#Analysis

Reading the data
```{r}
data_netherland<- read.csv("data/Death_week_2_17_netherland.csv", sep = ";")
data_england_wales <- read.csv("data/England_Wales_weekly.csv",sep = ";")
data_italy <- read.csv("data/italy_week_deaths.csv", sep = ",")
data_norway<- read.csv("data/Norway_total_death.csv", sep = ";")
```


Extracting the data for the Netherland
```{r}
mean_netherland <- as.vector(as.matrix(data_netherland)[,6])
netherland_2020<-as.vector(as.matrix(data_netherland)[,5])
```

Extracting data England and Wales
```{r}
mean_england <- as.vector(as.matrix(data_england_wales)[,12])
england_2020 <- as.vector(as.matrix(data_england_wales)[,13])
```

Extracting data Italy
```{r}
mean_italy <- as.vector(as.matrix(data_italy)[,9])
italy_2020 <- as.vector(as.matrix(data_italy)[,8])
```

Extracting the data for Norway
```{r}
mean_norway <- as.vector(as.matrix(data_norway)[,8])
norway_2020<-as.vector(as.matrix(data_norway)[,7])
```

###Setting up the stan lists

```{r}
create_list <- function(N, E, O){
  data_list <-  list(
  N = N, 
  E = E,
  O = O,
  phi_a = 1,
  phi_b = 6000,
  sigma_a = 0.01,
  sigma_b = 4,
  alpha_mu = 0,
  alpha_sigma = 4,
  beta_a = -1, 
  beta_b = 1,
  sigma_time_mu = 0,
  sigma_time_sigma= 25
  )
  return(data_list)
}
```


```{r}
data_list_netherland <- create_list(length(mean_netherland), mean_netherland, netherland_2020)
data_list_england_wales <- create_list( length(mean_england),mean_england,england_2020 )
data_list_italy <- create_list(length(mean_italy), mean_italy, italy_2020)
data_list_norway <- create_list(length(mean_norway), mean_norway, norway_2020)
```


Fit the stan models

<!-- The controlparameters and the number of itterations can be set in the params section on top -->
```{r, results="hide"}

risk_netherland <- stan(params$stanfile, iter = params$iter, chains = 4,
  data = data_list_netherland, seed = 1, control = list(adapt_delta = params$adapt_delta, max_treedepth = params$max_treedepth))

risk_england_wales <- stan(params$stanfile, iter = params$iter, chains = 4,
  data = data_list_england_wales, seed = 1, control = list(adapt_delta = params$adapt_delta, max_treedepth = params$max_treedepth))

risk_italy <- stan(params$stanfile, iter = params$iter, chains = 4,
  data = data_list_italy, seed = 1, control = list(adapt_delta = params$adapt_delta, max_treedepth = params$max_treedepth))

risk_norway <- stan(params$stanfile, iter = params$iter, chains = 4,
  data = data_list_norway, seed = 1, control = list(adapt_delta = params$adapt_delta, max_treedepth = params$max_treedepth))

```

There is a problem with divergency in our model meaning means and medians could be unreliable.

To explore this a bit more the pairs() function suggested by R are used.

<!-- Appearantly these red dots are a problem but I do not know how to fix it..  -->
```{r}
pairs(risk_netherland, pars = c("phi", "sigma", "alpha", "beta", "sigma_time"))
```






# Funtions

Funciton for outputgraphs
```{r}
plot_risk <- function(data, country_name){
  g<- ggplot(data = data, aes(x = week, y = theta)) + geom_point() + geom_line(lty = 2) +
  geom_line(aes(week, CI_lower), col = "blue", lty = 2) +
  geom_line(aes(week, CI_upper), col = "blue", lty = 2) + 
  geom_hline(yintercept = 1, col = "red")+
  ggtitle("Riskfactor for" , country_name)
  
  return(g)
}
```


Function for creating the dataframe with thetas and the bounds for the credible interval. 
```{r}
create_CI_theta_vec <- function(risk_data, N){
  fit<-summary(risk_data)
  results <- as.data.frame(fit$summary)
  
  CI_upper <- exp(results$`97.5%`[1:N] +results$`97.5%`[(N+1):(2*N)])
  CI_lower <- exp(results$`2.5%`[1:N] +results$`2.5%`[(N+1):(2*N)])

  theta <- exp(results$mean[1:N] +results$mean[(N+1):(2*N)])
  week <- seq(1:N)
  data <- data.frame(week, CI_upper, CI_lower, theta)
  return(data)

}
```



#Results

## Netherland

<!-- not sure if we need this in the report -->
```{r}
print(risk_netherland)
```

<!-- can this be used for validation?  -->
```{r}
library(bayesplot)
posterior <- as.data.frame(risk_netherland)
mcmc_trace(risk_netherland, pars = "log_theta[12]")
```


```{r}
data_netherland <- create_CI_theta_vec(risk_netherland, length(mean_netherland))
plot_risk(data_netherland, "Netherland")
```

## England and Wales
```{r}
data_england_wales <- create_CI_theta_vec(risk_england_wales, length(mean_england))
plot_risk(data_england_wales, "England and Wales")
```



## Italy 

```{r}
data_italy <- create_CI_theta_vec(risk_italy, length(mean_italy))
plot_risk(data_italy, "Italy")
```


## Norway

```{r}
data_norway <- create_CI_theta_vec(risk_norway, length(mean_norway))
plot_risk(data_norway, "Norway")
```

notice: negative risk in week 17!! Consistent with dat a:)  (norway goes from 2-17 in weeks)



#######################################################################################################################################

# Possible extentions

To extend the model one could explore an hierarchical model adding the different countries to the same model, add explanatory variables for the risk $\theta_i$ (% of elderly people, % smokers, % obecity, % time of lockdown). 

$log(\theta_i) \sim Normal(\beta_i + \beta_1 X_1 + \beta_2 X_2,\sigma_i^2)$

Also we would like to explore the possibility of doing the same model with E_i changing to the historical average plus the number of registered covid-19 deaths. Then the risk factor theta could share some light on how much unexplaind death occures in the different countries. 



